{% extends "base.html" %}

{% block title %}Chat com IA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h2>IA GYM chat</h2>
            </div>
            <div class="card-body">
                <div id="chat-messages" class="chat-messages" style="height: 400px; overflow-y: auto;"></div>
                <div id="download-buttons" class="mt-2" style="display: none;">
                    <button class="btn btn-sm btn-success" onclick="downloadAsCSV()">Download CSV</button>
                    <button class="btn btn-sm btn-info" onclick="downloadAsExcel()">Download Excel</button>
                    <button class="btn btn-sm btn-warning" onclick="downloadAsPNG()">Download PNG</button>
                </div>
                <form id="chat-form" class="mt-3">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Digite sua mensagem..." required>
                        <button class="btn btn-primary" type="submit">Enviar</button>
                        <button id="record-button" class="btn btn-danger" type="button" style="margin-left: 10px;">Gravar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
#message-input { background-color: #333; color: white; border: 1px solid #444; border-radius: 10px; padding: 10px; }
#message-input::placeholder { color: #bbb; opacity: 1; }
.message { margin: 10px; padding: 10px; border-radius: 10px; }
.user-message { background-color: #007bff; color: white; margin-left: 20%; }
.ai-message { background-color: #f8f9fa; margin-right: 20%; white-space: pre-line; }
.ai-message table { width: 100%; border-collapse: collapse; margin: 10px 0; }
.ai-message th, .ai-message td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.ai-message th { background-color: #f5f5f5; }
</style>

<script>
let mediaRecorder, audioChunks = [];
document.getElementById('record-button').addEventListener('click', async function() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        this.textContent = 'Parar';
        
        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            audioChunks = [];
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.wav');

            const response = await fetch('/transcribe_audio', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('message-input').value = data.transcription;
            } else {
                alert('Erro na transcrição: ' + data.message);
            }
        };
    } else {
        mediaRecorder.stop();
        this.textContent = 'Gravar';
    }
});

document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const message = messageInput.value;

    chatMessages.innerHTML += `<div class="message user-message">${message}</div>`;
    messageInput.value = '';

    const response = await fetch('/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `message=${encodeURIComponent(message)}`
    });

    const data = await response.json();
    if (data.status === 'success') {
        chatMessages.innerHTML += `<div class="message ai-message">${data.response}</div>`;
    } else {
        alert('Erro: ' + data.message);
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
{% endblock %}