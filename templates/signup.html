{% extends "base.html" %}

{% block title %}Cadastro - AI GYM{% endblock %}

{% block content %}
<div class="container" style="max-width: 500px; margin-top: 100px;">
    <div class="card shadow-lg" style="border-radius: 15px; background-color: #1f1f1f; color: white;">
        <div class="card-header text-center" style="background-color: #121212; border-radius: 15px 15px 0 0;">
            <h2 style="color: #00ff99;">Cadastro - AI GYM</h2>
        </div>
        <div class="card-body">
            <form id="signupForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Usuário</label>
                    <input type="text" class="form-control" id="username" name="username" required style="background-color: #333; color: white; border: 1px solid #444;">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="password" name="password" required style="background-color: #333; color: white; border: 1px solid #444;">
                </div>
                <button type="submit" class="btn btn-success w-100 mb-3" style="font-size: 1.2em; font-weight: bold; padding: 12px; background: linear-gradient(135deg, #00ff99, #00cc66); border: none; transition: all 0.3s ease;">
                    Cadastrar
                </button>
                <button type="button" id="faceRegisterBtn" class="btn btn-primary w-100" style="font-size: 1.2em; font-weight: bold; padding: 12px; background: linear-gradient(135deg, #0066ff, #0044cc); border: none; transition: all 0.3s ease;">
                    Cadastrar Face
                </button>
            </form>
            <div id="videoContainer" style="display: none; margin-top: 20px;">
                <video id="video" width="100%" autoplay></video>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>
        </div>
        <div class="card-footer text-center" style="background-color: #121212; border-radius: 0 0 15px 15px;">
            <p style="font-size: 0.9em;">Já tem uma conta? <a href="/login" style="color: #00ff99; text-decoration: none;">Faça login</a></p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>

<script>
let video = null;
let stream = null;
let photosTaken = 0;
const REQUIRED_PHOTOS = 30; // Número de fotos necessárias para cadastro

document.getElementById('faceRegisterBtn').addEventListener('click', async () => {
    const videoContainer = document.getElementById('videoContainer');
    
    if (videoContainer.style.display === 'none') {
        videoContainer.style.display = 'block';
        video = document.getElementById('video');
        
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            
            startFaceDetection();
        } catch (err) {
            console.error("Erro ao acessar câmera:", err);
            alert("Não foi possível acessar a câmera");
        }
    } else {
        stopCamera();
    }
});

async function startFaceDetection() {
    const model = await faceDetection.createDetector();
    const captureInterval = setInterval(async () => {
        if (video && video.readyState === 4) {
            const faces = await model.estimateFaces(video, {
                flipHorizontal: false
            });
            
            if (faces.length > 0 && photosTaken < REQUIRED_PHOTOS) {
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg');
                
                try {
                    const response = await fetch('/register_face', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            image: imageData,
                            user_id: document.getElementById('username').value
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        photosTaken++;
                        if (photosTaken >= REQUIRED_PHOTOS) {
                            clearInterval(captureInterval);
                            stopCamera();
                            alert("Cadastro facial concluído com sucesso!");
                            // Submeter o formulário de cadastro
                            document.getElementById('signupForm').submit();
                        }
                    }
                } catch (err) {
                    console.error("Erro ao enviar imagem:", err);
                }
            }
        }
    }, 500); // Captura uma foto a cada 500ms
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    if (video) {
        video.srcObject = null;
    }
    document.getElementById('videoContainer').style.display = 'none';
}
</script>
{% endblock %} 